name: Sapog tests
on: push
jobs:
  heartbeat:
    runs-on: [ self-hosted ]
    steps:
      - name: checking out
        uses: actions/checkout@v2
      - name: Turning on the USB port
        run: sudo ykushcmd ykush3 -u 1
      - name: Building Sapog
        run: python firmware/tests/src/builder.py build
      - name: Powering on psu
        run: groom_power.py on
      - name: Powering on sapog
        run: groom_power.py -v 15
      - name: Flashing Sapog
        run: python3 firmware/tests/src/builder.py flash
      - name: Running tests
        run: PYTHONPATH=$PYTHONPATH:/home/zubaxpc/sapog-runner/_work/sapog/sapog/firmware/tests/deps/namespaces/ python3 -m pytest /home/zubaxpc/sapog-runner/_work/sapog/sapog/firmware/tests/src/tester.py
      - name: Cleanup
        if: ${{ failure() }}
        run: |
          sudo ykushcmd ykush3 -d 1
          groom_power.py poweroff
